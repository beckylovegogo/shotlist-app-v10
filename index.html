<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <title>Shot List AI (Enhanced)</title>
    <style>
        :root { --primary: #0A84FF; --accent: #FFFFFF; --bg: #000; --card: #1c1c1e; }
        body { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; height: 100dvh; width: 100vw; overflow: hidden; touch-action: none; }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* Camera */
        video#camera-feed { position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; display: none; image-rendering: high-quality; }
        #ui-layer { position: relative; z-index: 10; height: 100%; width: 100%; background: var(--bg); display: flex; flex-direction: column; transition: background 0.5s; }

        /* Setup */
        #page-setup { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 40px 30px; background: radial-gradient(circle at top right, #1a1a1a, #000000); }
        h1 { font-size: 36px; font-weight: 800; text-align: center; background: linear-gradient(to right, #fff, #999); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 40px; }
        
        /* æ–°å¢ï¼šæ¨¡å¼åˆ‡æ›æ¨™ç±¤ */
        .mode-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .mode-tab { flex: 1; padding: 12px; background: var(--card); border: 1px solid #333; color: #888; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .mode-tab.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        input, select, textarea { width: 100%; padding: 16px; background: var(--card); border: 1px solid #333; color: white; border-radius: 12px; margin-bottom: 20px; font-size: 16px; outline: none; }
        textarea { min-height: 200px; font-family: monospace; resize: vertical; line-height: 1.6; }
        .btn-main { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 16px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .hint-text { margin-top: 15px; font-size: 13px; color: #888; line-height: 1.6; }

        /* Preview */
        #page-preview { display: none; flex: 1; flex-direction: column; background: #000; height: 100%; overflow: hidden; }
        .preview-header { flex-shrink: 0; background: #111; border-bottom: 1px solid #333; padding-top: env(safe-area-inset-top); }
        .nav-bar { display: flex; justify-content: space-between; padding: 15px 20px; }
        .nav-btn { background: none; border: none; color: var(--primary); font-size: 16px; font-weight: bold; padding: 5px; cursor: pointer; }
        .tab-box { display: flex; padding: 0 20px 15px 20px; gap: 15px; }
        .tab-btn { flex: 1; padding: 12px; text-align: center; color: #888; font-weight: bold; border-radius: 12px; background: #1c1c1e; border: 1px solid #333; transition: 0.2s; cursor: pointer; font-size: 15px; }
        .tab-btn.active { background: #333; color: #fff; border-color: #555; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .script-list { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; }
        .script-item { background: var(--card); padding: 20px; border-radius: 18px; margin-bottom: 12px; border: 1px solid #333; }
        
        /* Tags */
        .tags { display: flex; gap: 10px; margin-bottom: 10px; }
        .tag { font-size: 14px; padding: 6px 10px; border-radius: 8px; font-weight: bold; letter-spacing: 0.5px; }
        .tag-shot { background: rgba(255, 255, 255, 0.85); color: #000; border: none; box-shadow: 0 2px 5px rgba(255,255,255,0.1); }
        .tag-move { background: rgba(10,132,255,0.25); color: #64D2FF; border: 1px solid rgba(10,132,255,0.3); }
        
        .s-title { font-size: 20px; font-weight: bold; margin-bottom: 6px; color: #fff; }
        .s-desc { font-size: 16px; color: #aaa; line-height: 1.5; }
        .fab-start { position: fixed; bottom: 40px; left: 5%; width: 90%; background: #FFFFFF; color: #000000; padding: 18px; border-radius: 30px; border: none; font-weight: 800; font-size: 18px; z-index: 99; box-shadow: 0 10px 30px rgba(255,255,255,0.2); cursor: pointer; }

        /* AR Shooting */
        #page-ar { display: none; height: 100%; width: 100%; position: relative; padding: 20px; pointer-events: none; }
        #page-ar > * { pointer-events: auto; }
        .hud-container { position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 8px; align-items: flex-start; z-index: 20; }
        .hud-badge { background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 16px; font-weight: 800; letter-spacing: 0.5px; border-left: 4px solid #fff; }
        .hud-blue { border-color: #0A84FF; color: #0A84FF; }
        
        #rec-timer { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(255, 69, 58, 0.8); padding: 5px 15px; border-radius: 20px; display: none; align-items: center; gap: 8px; z-index: 30; color: white; font-weight: bold;}
        .rec-dot { width: 10px; height: 10px; background: #fff; border-radius: 50%; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
        
        .ar-card-container { position: absolute; bottom: 140px; left: 20px; right: 20px; z-index: 20; transition: opacity 0.3s; }
        .glass-card { background: rgba(0,0,0,0.75); backdrop-filter: blur(20px); border-radius: 24px; padding: 20px; border: 1px solid rgba(255,255,255,0.2); display: flex; gap: 15px; align-items: flex-start; }
        .ar-thumb { width: 80px; height: 80px; border-radius: 12px; background: #333; object-fit: cover; flex-shrink: 0; }
        .ar-title { font-size: 20px; font-weight: bold; margin-bottom: 4px; line-height: 1.2; }
        .ar-desc { font-size: 15px; color: #ddd; line-height: 1.4; }
        .ar-move-tag { font-size: 12px; color: var(--primary); font-weight: bold; margin-bottom: 4px; display: block; }
        
        .camera-controls { position: absolute; bottom: 40px; left: 20px; right: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 30; }
        .ctrl-btn-text { padding: 14px 22px; border-radius: 30px; background: rgba(0, 0, 0, 0.6); border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(10px); color: white; font-size: 16px; font-weight: bold; display: flex; justify-content: center; align-items: center; min-width: 90px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; }
        .ctrl-btn-text:disabled { opacity: 0.3; background: rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.1); }
        .shutter-outer { width: 76px; height: 76px; border-radius: 50%; border: 4px solid white; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .shutter-inner { width: 64px; height: 64px; border-radius: 50%; background: #FF453A; transition: 0.3s; }
        .shutter-outer.recording .shutter-inner { width: 30px; height: 30px; border-radius: 6px; }

        #overlay-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        .status-text { font-size: 14px; color: #888; margin-top: 10px; }
        
        #wrap-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .wrap-card { background: #1c1c1e; border-radius: 30px; padding: 40px 30px; text-align: center; border: 1px solid #333; width: 80%; max-width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: popUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .wrap-icon { font-size: 60px; margin-bottom: 20px; display: block; }
        .wrap-title { font-size: 24px; font-weight: 800; margin-bottom: 10px; background: linear-gradient(to right, #FFD700, #FF8C00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .wrap-text { font-size: 16px; color: #aaa; margin-bottom: 30px; line-height: 1.5; }
        .btn-home { width: 100%; padding: 16px; background: #333; color: white; border: none; border-radius: 16px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-home:active { background: #444; }

    </style>
</head>
<body>
    <video id="camera-feed" autoplay playsinline muted></video>

    <div id="overlay-loading">
        <div style="font-size:30px;margin-bottom:10px">ğŸª„</div>
        <div style="font-size:18px;font-weight:bold">AI å°æ¼”æ§‹æ€ä¸­...</div>
        <div class="status-text" id="status-text">æ­£åœ¨é€£æ¥ä¼ºæœå™¨</div>
    </div>

    <div id="wrap-modal">
        <div class="wrap-card">
            <span class="wrap-icon">ğŸ¬</span>
            <div class="wrap-title">IT'S A WRAP!</div>
            <div class="wrap-text">æ­å–œæ®ºé’ï¼<br>æ‰€æœ‰é¡é ­å·²æ‹æ”å®Œæˆ</div>
            <button class="btn-home" onclick="location.reload()">å›åˆ°é¦–é </button>
        </div>
    </div>

    <div id="ui-layer">
        <div id="page-setup">
            <h1>SHOT LIST AI</h1>
            
            <!-- æ–°å¢ï¼šæ¨¡å¼åˆ‡æ› -->
            <div class="mode-tabs">
                <button class="mode-tab active" onclick="switchMode('generate')" id="tab-generate">
                    ğŸ¤– AI ç”Ÿæˆ
                </button>
                <button class="mode-tab" onclick="switchMode('import')" id="tab-import">
                    ğŸ“„ å°å…¥è…³æœ¬
                </button>
            </div>
            
            <!-- AI ç”Ÿæˆæ¨¡å¼ -->
            <div id="mode-generate">
                <input type="text" id="topic" placeholder="è¼¸å…¥ä¸»é¡Œ (ä¾‹: æ‹ä¸€æ¯å’–å•¡)">
                <select id="format">
                    <option value="Shorts">ğŸ“± çŸ­å½±éŸ³ (Reels)</option>
                    <option value="Vlog">ğŸ“¹ YouTube é•·ç‰‡</option>
                    <option value="Cinematic">ğŸ¬ é›»å½±æ„Ÿ B-Roll</option>
                </select>
                <button class="btn-main" onclick="generateScripts()">AI ç”Ÿæˆè…³æœ¬</button>
            </div>
            
            <!-- æ–°å¢ï¼šå°å…¥è…³æœ¬æ¨¡å¼ -->
            <div id="mode-import" style="display: none;">
                <textarea 
                    id="script-input" 
                    placeholder="è²¼ä¸Šä½ çš„è…³æœ¬å…§å®¹ï¼Œä¾‹å¦‚ï¼š

Scene 1 - å®¤å¤–å’–å•¡åº— - ç™½å¤©
ç‰¹å¯«ï¼šå’–å•¡æ¯å†’å‡ºè’¸æ°£
é‹é¡ï¼šå›ºå®šæ©Ÿä½

Scene 2 - å§å°
ä¸­æ™¯ï¼šå’–å•¡å¸«è£½ä½œæ‹‰èŠ±
é‹é¡ï¼šç”±å·¦è‡³å³å¹³ç§»

æˆ–ç›´æ¥åˆ—å‡ºé¡é ­ï¼š
ç‰¹å¯«å’–å•¡æ¯ï¼Œè’¸æ°£ä¸Šå‡
ä¸­æ™¯å’–å•¡å¸«æ‹‰èŠ±
å»£è§’åº—å…§å…¨æ™¯"
                ></textarea>
                
                <button class="btn-main" onclick="parseImportedScript()">
                    è§£æè…³æœ¬ä¸¦é–‹å§‹æ‹æ”
                </button>
                
                <div class="hint-text">
                    ğŸ’¡ æ”¯æ´æ ¼å¼ï¼š<br>
                    â€¢ æ¯å€‹å ´æ™¯ç”¨ "Scene X" é–‹é ­<br>
                    â€¢ æˆ–ç›´æ¥åˆ—å‡ºé¡é ­æè¿°ï¼ˆæ¯è¡Œä¸€å€‹ï¼‰<br>
                    â€¢ ç³»çµ±æœƒè‡ªå‹•è­˜åˆ¥é¡é ­é¡å‹å’Œé‹é¡
                </div>
            </div>
        </div>

        <div id="page-preview">
            <div class="preview-header">
                <div class="nav-bar">
                    <button class="nav-btn" onclick="goBack()">â® ä¿®æ”¹ä¸»é¡Œ</button>
                    <button class="nav-btn" onclick="confirmSelection()">ç¢ºèªæ‹æ”</button>
                </div>
                <div class="tab-box">
                    <button class="tab-btn active" id="tab-a" onclick="switchTab('A')">æ–¹æ¡ˆ A</button>
                    <button class="tab-btn" id="tab-b" onclick="switchTab('B')">æ–¹æ¡ˆ B</button>
                </div>
            </div>
            <div class="script-list" id="list-a"></div>
            <div class="script-list" id="list-b" style="display:none"></div>
            <button class="fab-start" onclick="confirmSelection()">âœ“ ç¢ºèªä¸¦é–‹å§‹æ‹æ”</button>
        </div>

        <div id="page-ar">
            <div class="hud-container">
                <div class="hud-badge" id="ar-idx">1/6</div>
                <div class="hud-badge hud-blue" id="ar-shot-type">ç‰¹å¯«</div>
            </div>
            <div id="rec-timer">
                <div class="rec-dot"></div>
                <span id="timer-text">00:00</span>
            </div>
            <div class="ar-card-container" id="ar-card">
                <div class="glass-card">
                    <img id="ar-thumb" class="ar-thumb" src="" alt="">
                    <div style="flex:1">
                        <span class="ar-move-tag" id="ar-move">å›ºå®šé¡é ­</span>
                        <div class="ar-title" id="ar-title">å’–å•¡è’¸æ°£</div>
                        <div class="ar-desc" id="ar-desc">ç‰¹å¯«å’–å•¡æ¯...</div>
                    </div>
                </div>
            </div>
            <div class="camera-controls">
                <button class="ctrl-btn-text" id="btn-prev" onclick="prevShot()">â® ä¸Šä¸€é¡</button>
                <div class="shutter-outer" id="shutter-btn" onclick="toggleRecord()"><div class="shutter-inner"></div></div>
                <button class="ctrl-btn-text" id="btn-next" onclick="nextShot()">ä¸‹ä¸€é¡ â¯</button>
            </div>
        </div>
    </div>

    <script>
        // ç¦æ­¢ç¸®æ”¾
        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
        
        const API_KEY = "AIzaSyBNRTr84ne2N1ikiUkMt2HilmiwuZvHXCY"; 
        let dataA=[], dataB=[], currentList=[], shotIdx=0;
        let mediaRecorder, recordedChunks=[], isRecording=false, timerInt;

        // ========== æ–°å¢ï¼šæ¨¡å¼åˆ‡æ› ==========
        function switchMode(mode) {
            document.querySelectorAll('.mode-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${mode}`).classList.add('active');
            
            if (mode === 'generate') {
                document.getElementById('mode-generate').style.display = 'block';
                document.getElementById('mode-import').style.display = 'none';
            } else {
                document.getElementById('mode-generate').style.display = 'none';
                document.getElementById('mode-import').style.display = 'block';
            }
        }

        // ========== æ”¹é€²ï¼šæ›´å¥½çš„ Gemini Prompt ==========
        function buildImprovedPrompt(topic, format) {
            const formatGuides = {
                "Shorts": {
                    count: "6-8",
                    style: "å¿«ç¯€å¥ã€è¦–è¦ºè¡æ“Šã€é©åˆç›´å¼",
                    movements: "å¿«é€Ÿå¹³ç§»ã€è·Ÿæ‹ã€æ¨é€²",
                    tips: "æ¯é¡2-5ç§’ï¼Œå¼·èª¿è¦–è¦ºè®ŠåŒ–"
                },
                "Vlog": {
                    count: "12-15",
                    style: "è‡ªç„¶ã€è¦ªåˆ‡ã€æ•…äº‹æ€§",
                    movements: "æ‰‹æŒè·Ÿæ‹ã€å›ºå®šã€ç·©æ…¢å¹³ç§»",
                    tips: "å»ºç«‹é€£çµï¼Œå±•ç¾çœŸå¯¦"
                },
                "Cinematic": {
                    count: "8-12",
                    style: "é›»å½±æ„Ÿã€æƒ…ç·’æ°›åœ",
                    movements: "æ¨é€²ã€ç’°ç¹ã€éœæ…‹é•·é¡é ­",
                    tips: "å¼·èª¿å…‰å½±ã€æ§‹åœ–ã€æƒ…ç·’"
                }
            };

            const guide = formatGuides[format];
            
            return `ä½ æ˜¯å°ˆæ¥­é›»å½±æ”å½±æŒ‡å°ã€‚ç‚ºã€Œ${topic}ã€è¨­è¨ˆå…©å¥—æ‹æ”è…³æœ¬ã€‚

æ ¼å¼ï¼š${format}
é¢¨æ ¼ï¼š${guide.style}
é¡é ­æ•¸ï¼šåš´æ ¼ ${guide.count} å€‹
é‹é¡é¸é …ï¼š${guide.movements}

æ¯å€‹é¡é ­åŒ…å«ï¼š
{
  "shot_size": "ç‰¹å¯«/è¿‘æ™¯/ä¸­æ™¯/å…¨æ™¯/é æ™¯",
  "movement": "${guide.movements}ä¸­é¸ä¸€å€‹",
  "title": "é¡é ­æ¨™é¡Œï¼ˆ15å­—å…§ï¼‰",
  "visual": "è©³ç´°ç•«é¢æè¿°ï¼ˆè‡³å°‘50å­—ï¼‰ï¼š
    - ä¸»é«”å‹•ä½œå’Œè¡¨æƒ…
    - å…‰ç·šå’Œè‰²èª¿ï¼ˆå¦‚ï¼šæº«æš–å´å…‰ã€å†·èª¿é ‚å…‰ï¼‰
    - æ§‹åœ–æ–¹å¼ï¼ˆå¦‚ï¼šä¸‰åˆ†æ³•ã€ä¸­å¿ƒæ§‹åœ–ï¼‰
    - æƒ…ç·’æ°›åœï¼ˆå¦‚ï¼šå¯§éœã€ç·Šå¼µï¼‰
    - èƒŒæ™¯ç’°å¢ƒç´°ç¯€",
  "duration": "å»ºè­°æ™‚é•·ï¼ˆå¦‚ï¼š3ç§’ã€5-8ç§’ï¼‰",
  "audio_note": "è²éŸ³å»ºè­°",
  "img_prompt": "è‹±æ–‡åœ–åƒæç¤ºè©"
}

è¦æ±‚ï¼š
1. planAï¼ˆç¶“å…¸æ–¹æ¡ˆï¼‰ï¼šå‚³çµ±ã€ç©©å®šã€é©åˆæ–°æ‰‹
2. planBï¼ˆå‰µæ„æ–¹æ¡ˆï¼‰ï¼šå¤§è†½ã€ç¨ç‰¹ã€è—è¡“æ„Ÿ
3. visual æè¿°è‡³å°‘50å­—ï¼ŒåŒ…å«å…‰ç·šã€è‰²å½©ã€æ§‹åœ–
4. é‹é¡è¦å…·é«”ï¼ˆå¦‚ï¼šã€Œç”±å·¦è‡³å³ç·©æ…¢å¹³ç§»ï¼Œ3ç§’å…§å®Œæˆã€ï¼‰
5. æ‰‹æ©Ÿæ‹æ”é™åˆ¶ï¼šç¦æ­¢èˆªæ‹ã€è‚©æ‰›ã€å°ˆæ¥­è»Œé“

ä½¿ç”¨ç¹é«”ä¸­æ–‡ï¼ˆå°ç£ï¼‰ã€‚
è¼¸å‡ºåš´æ ¼ JSON æ ¼å¼ï¼š
{
  "planA": [...],
  "planB": [...]
}`;
        }

        async function fetchGemini(prompt) {
            const models = ["gemini-2.0-flash", "gemini-1.5-flash", "gemini-1.5-pro"];
            for (let model of models) {
                try {
                    document.getElementById('status-text').innerText = `æ­£åœ¨å˜—è©¦ ${model}...`;
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`, {
                        method: "POST", headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                    });
                    if (!res.ok) throw new Error(res.statusText);
                    return await res.json();
                } catch (e) { console.warn(`${model} failed`); }
            }
            throw new Error("All models failed");
        }

        async function generateScripts() {
            const topic = document.getElementById('topic').value;
            const format = document.getElementById('format').value;
            if(!topic) return alert("è«‹è¼¸å…¥ä¸»é¡Œ");

            document.getElementById('overlay-loading').style.display = 'flex';
            
            // ä½¿ç”¨æ”¹é€²çš„ prompt
            const prompt = buildImprovedPrompt(topic, format);

            try {
                const json = await fetchGemini(prompt);
                const txt = json.candidates[0].content.parts[0].text.replace(/```json|```/g, "").trim();
                const parsed = JSON.parse(txt);
                dataA = parsed.planA; dataB = parsed.planB;
                
                renderList('list-a', dataA); renderList('list-b', dataB);
                document.getElementById('overlay-loading').style.display = 'none';
                document.getElementById('page-setup').style.display = 'none';
                document.getElementById('page-preview').style.display = 'flex';
                
                // é¡¯ç¤ºå…©å€‹æ–¹æ¡ˆæ¨™ç±¤
                document.getElementById('tab-b').style.display = 'block';
                switchTab('A');
            } catch(e) { 
                alert("ç”Ÿæˆå¤±æ•—ï¼š" + e.message); 
                document.getElementById('overlay-loading').style.display = 'none'; 
            }
        }

        // ========== æ–°å¢ï¼šå°å…¥è…³æœ¬åŠŸèƒ½ ==========
        function parseImportedScript() {
            const input = document.getElementById('script-input').value.trim();
            
            if (!input) {
                alert('è«‹è²¼ä¸Šè…³æœ¬å…§å®¹');
                return;
            }
            
            try {
                const parsed = parseScriptText(input);
                
                if (parsed.length === 0) {
                    alert('ç„¡æ³•è§£æè…³æœ¬ï¼Œè«‹æª¢æŸ¥æ ¼å¼');
                    return;
                }
                
                dataA = parsed;
                dataB = [];
                
                renderList('list-a', dataA);
                document.getElementById('list-b').innerHTML = '<div style="text-align:center; padding:40px; color:#666;">å°å…¥æ¨¡å¼åƒ…æœ‰ä¸€å¥—è…³æœ¬</div>';
                
                document.getElementById('page-setup').style.display = 'none';
                document.getElementById('page-preview').style.display = 'flex';
                
                // éš±è— B æ–¹æ¡ˆæ¨™ç±¤
                document.getElementById('tab-b').style.display = 'none';
                switchTab('A');
                
                console.log('âœ… æˆåŠŸå°å…¥', parsed.length, 'å€‹é¡é ­');
                
            } catch (e) {
                alert('è§£æè…³æœ¬æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message);
                console.error(e);
            }
        }

        function parseScriptText(text) {
            const shots = [];
            const scenePattern = /Scene\s+\d+[^\n]*/gi;
            const sceneMatches = text.match(scenePattern);
            
            if (sceneMatches && sceneMatches.length > 0) {
                const sceneSections = text.split(scenePattern).filter(s => s.trim());
                sceneMatches.forEach((sceneHeader, idx) => {
                    const content = sceneSections[idx] || '';
                    const lines = content.split('\n').map(l => l.trim()).filter(l => l);
                    if (lines.length > 0) {
                        shots.push(parseSceneContent(sceneHeader, lines, idx + 1));
                    }
                });
            } else {
                const lines = text.split('\n')
                    .map(l => l.trim())
                    .filter(l => l && !l.startsWith('//') && !l.startsWith('#'));
                
                lines.forEach((line, idx) => {
                    if (line.length > 5) {
                        shots.push(parseSingleLine(line, idx + 1));
                    }
                });
            }
            
            return shots;
        }

        function parseSceneContent(header, lines, index) {
            const shotTypes = ['ç‰¹å¯«', 'è¿‘æ™¯', 'ä¸­æ™¯', 'å…¨æ™¯', 'é æ™¯', 'å¤§é æ™¯'];
            const movements = ['å›ºå®š', 'å¹³ç§»', 'æ¨é€²', 'æ‹‰é ', 'æ–é¡', 'è·Ÿæ‹', 'ç’°ç¹', 'å‡é™'];
            
            let shotSize = 'ä¸­æ™¯';
            let movement = 'å›ºå®š';
            let title = header;
            let visual = lines.join('ã€‚');
            
            for (const type of shotTypes) {
                if (visual.includes(type)) {
                    shotSize = type;
                    break;
                }
            }
            
            for (const move of movements) {
                if (visual.includes(move)) {
                    movement = move;
                    break;
                }
            }
            
            if (lines[0] && lines[0].length < 30) {
                title = lines[0];
                visual = lines.slice(1).join('ã€‚');
            }
            
            return {
                shot_size: shotSize,
                movement: movement,
                title: title || `é¡é ­ ${index}`,
                visual: visual || 'ç•«é¢æè¿°',
                duration: '5ç§’',
                audio_note: 'ç¾å ´æ”¶éŸ³',
                img_prompt: `cinematic shot, ${title}, professional filmmaking`
            };
        }

        function parseSingleLine(line, index) {
            const shotTypes = ['ç‰¹å¯«', 'è¿‘æ™¯', 'ä¸­æ™¯', 'å…¨æ™¯', 'é æ™¯'];
            const movements = ['å›ºå®š', 'å¹³ç§»', 'æ¨é€²', 'æ‹‰é ', 'æ–é¡', 'è·Ÿæ‹', 'ç’°ç¹'];
            
            let shotSize = 'ä¸­æ™¯';
            let movement = 'å›ºå®š';
            
            for (const type of shotTypes) {
                if (line.includes(type)) {
                    shotSize = type;
                    break;
                }
            }
            
            for (const move of movements) {
                if (line.includes(move)) {
                    movement = move;
                    break;
                }
            }
            
            const title = line.substring(0, 20) + (line.length > 20 ? '...' : '');
            
            return {
                shot_size: shotSize,
                movement: movement,
                title: title,
                visual: line,
                duration: '5ç§’',
                audio_note: 'ç¾å ´æ”¶éŸ³',
                img_prompt: `cinematic shot, professional filmmaking`
            };
        }

        function renderList(id, list) {
            document.getElementById(id).innerHTML = list.map((s,i)=>`
                <div class="script-item">
                    <div class="tags">
                        <span class="tag tag-shot">${s.shot_size||'é¡é ­'}</span>
                        <span class="tag tag-move">${s.movement||'å›ºå®š'}</span>
                    </div>
                    <div class="s-title">${i+1}. ${s.title}</div>
                    <div class="s-desc">${s.visual}</div>
                </div>`).join('');
        }

        function switchTab(t) { 
            currentList = t==='A'?dataA:dataB; 
            document.getElementById('list-a').style.display = t==='A'?'block':'none';
            document.getElementById('list-b').style.display = t==='B'?'block':'none';
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById('tab-'+t.toLowerCase()).classList.add('active');
        }
        function goBack() { document.getElementById('page-preview').style.display='none'; document.getElementById('page-setup').style.display='flex'; }

        async function confirmSelection() {
            currentList = document.getElementById('list-a').style.display==='block' ? dataA : dataB;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true,
                    video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 }, frameRate: { ideal: 30, max: 30 } }
                });
                document.getElementById('camera-feed').srcObject = stream;
                document.getElementById('camera-feed').style.display = 'block';
                setupRecorder(stream);
            } catch(e) { console.log("ç›¸æ©Ÿç•°å¸¸"); }
            
            document.getElementById('page-preview').style.display = 'none';
            document.getElementById('ui-layer').style.background = 'transparent';
            document.getElementById('page-ar').style.display = 'block';
            shotIdx = 0; 
            speak("Standby.");
            updateAR();
        }

        function setupRecorder(stream) {
            let options = { mimeType: 'video/webm;codecs=vp9', videoBitsPerSecond: 5000000 };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/webm' };
            if (!MediaRecorder.isTypeSupported(options.mimeType)) options = { mimeType: 'video/mp4' };
            try {
                mediaRecorder = new MediaRecorder(stream, options);
                mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: "video/webm" });
                    recordedChunks = [];
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.style.display = "none"; a.href = url; a.download = `shot_${shotIdx}_${Date.now()}.webm`;
                    document.body.appendChild(a); a.click();
                };
            } catch(e) {}
        }

        function toggleRecord() {
            if(!mediaRecorder) return;
            const btn = document.getElementById('shutter-btn');
            const timerUI = document.getElementById('rec-timer');
            if(!isRecording) {
                recordedChunks = []; mediaRecorder.start(); isRecording = true;
                btn.classList.add('recording'); timerUI.style.display = 'flex';
                document.getElementById('ar-card').style.opacity = '0.3';
                let sec = 0; timerInt = setInterval(() => { sec++; document.getElementById('timer-text').innerText = `00:${sec.toString().padStart(2,'0')}`; }, 1000);
            } else {
                mediaRecorder.stop(); isRecording = false;
                btn.classList.remove('recording'); timerUI.style.display = 'none';
                document.getElementById('ar-card').style.opacity = '1';
                clearInterval(timerInt);
                document.getElementById('timer-text').innerText = "00:00";
            }
        }

        function updateAR() {
            if(shotIdx >= currentList.length) { 
                document.getElementById('wrap-modal').style.display = 'flex';
                speak("It's a wrap!");
                return; 
            }
            const s = currentList[shotIdx];
            document.getElementById('ar-idx').innerText = `${shotIdx+1}/${currentList.length}`;
            document.getElementById('ar-shot-type').innerText = s.shot_size || 'é¡é ­';
            document.getElementById('ar-move').innerText = s.movement || 'å›ºå®š';
            document.getElementById('ar-title').innerText = s.title;
            document.getElementById('ar-desc').innerText = s.visual;
            document.getElementById('ar-thumb').src = `https://image.pollinations.ai/prompt/${encodeURIComponent(s.img_prompt)}?width=100&height=100&nologo=true`;
            document.getElementById('btn-prev').disabled = (shotIdx === 0);
            speak(`Action. Cut ${shotIdx + 1}`);
        }

        function nextShot() { if(isRecording) toggleRecord(); shotIdx++; updateAR(); }
        function prevShot() { if(isRecording) toggleRecord(); if(shotIdx > 0) { shotIdx--; updateAR(); } }
        function speak(txt) { if('speechSynthesis' in window){ window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(txt); u.lang = "en-US"; window.speechSynthesis.speak(u); } }
    </script>
</body>
</html>
